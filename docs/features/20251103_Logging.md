# Feature: Application Insights + Business Metrics Tracking

## Problem
Email functionality works but no error logs visible in Azure production. Cannot troubleshoot failed email sends or track business metrics.

## Solution
Implement Application Insights with comprehensive logging and custom business metrics.

## Implementation

### 1. Application Insights Integration
- **Package:** `Microsoft.ApplicationInsights.AspNetCore`
- **Configuration:** Program.cs + appsettings.json
- **Azure:** Connection string in App Settings

### 2. Logging Points
- **ConfiguratorFormPage.razor:**
  - Form submission start/success/failure
  - Customer email/phone (structured logging)
  - Email send results
  - Exception details with full context

- **Error.razor:**
  - Unhandled exceptions
  - Request context (TraceIdentifier)

- **Production log levels:**
  - Default: Information
  - Microsoft.AspNetCore: Warning
  - Custom telemetry for form flow

### 3. Business Metrics (Custom Telemetry)
- **Daily Inquiries:** Count of successful form submissions
- **Daily Revenue Potential:** Sum of price estimates
- **Tracked Properties:**
  - Customer email
  - Order value (CZK)
  - Dimensions (A, B, C)
  - Roof type
  - Timestamp

### 4. Azure Configuration Required
```
APPLICATIONINSIGHTS_CONNECTION_STRING=InstrumentationKey=...
Email__SmtpUsername=<username>
Email__SmtpPassword=<password> (use Key Vault)
```

## Issues Found & Fixed

### Email Template Loading (2025-11-03)
**Problem:** Email templates not found in Azure (`FileNotFoundException: /home/site/wwwroot/Email_Template_Manager.html`)

**Root Causes:**
1. `Directory.GetCurrentDirectory()` unreliable in Azure App Service
2. Templates not included in publish output - `<Content Update>` doesn't work for non-wwwroot files

**Fixes Applied:**

1. **SmtpEmailService.cs:**
   - Inject `IWebHostEnvironment`
   - Use `ContentRootPath` instead of `Directory.GetCurrentDirectory()`
   - Added detailed logging for template loading
   - Added file existence check before loading

2. **Ocelis.Configurator.BlazorApp.csproj:**
   - Changed from `<Content Update>` to `<None Include>`
   - Added `<CopyToPublishDirectory>Always</CopyToPublishDirectory>` (critical for Azure)
   - Ensures templates are included in dotnet publish output

**Files Changed:**
- [SmtpEmailService.cs](../src/Ocelis.Configurator.BlazorApp/Services/SmtpEmailService.cs)
- [Ocelis.Configurator.BlazorApp.csproj](../src/Ocelis.Configurator.BlazorApp/Ocelis.Configurator.BlazorApp.csproj)

## Benefits
- ✅ Persistent logs in Azure (queryable for 90 days default)
- ✅ Exception tracking with stack traces
- ✅ Business metrics dashboard (inquiries/day, revenue/day)
- ✅ Performance monitoring
- ✅ Email troubleshooting capability
- ✅ Email templates load correctly in Azure

## Querying Metrics (Azure Portal)
```kusto
// Daily inquiries
customEvents
| where name == "InquirySubmitted"
| summarize count() by bin(timestamp, 1d)

// Daily revenue potential
customMetrics
| where name == "OrderValue"
| summarize sum(value) by bin(timestamp, 1d)
``` 