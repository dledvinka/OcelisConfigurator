@page "/configurator-form"
@inject ISnackbar Snackbar
@inject IEmailService EmailService
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using Ocelis.Configuration.BlazorApp.Components.Shared
@using Ocelis.Configuration.BlazorApp.Services

<EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid>

        <MudItem xs="12" md="6" Class="d-flex justify-center align-center" >
            @if (_model.RoofType.Id == (int)RoofType.Flat)
            {
                <MudImage ObjectFit="ObjectFit.Cover" Src="images/RovnaStrecha_600_600.jpg" Alt="Rovný typ střechy" Class="rounded-lg" Style="width: 100%; height: 682px; max-width: 682px; max-height: 682px;" />
            }
            else
            {
                <MudImage ObjectFit="ObjectFit.Cover" Src="images/SedlovaStrecha_600_600.jpg" Alt="Sedlový typ střechy" Class="rounded-lg" Style="width: 100%; height: 682px; max-width: 682px; max-height: 682px;" />
            }
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h5" Class="mb-4">Zadejte požadované rozměry a typ střechy</MudText>

                    <MudNumericField Label="Rozměr A v milimetrech"
                                     Margin="Margin.Normal"
                                     @bind-Value="_model.DimensionA"
                                     @bind-Value:after="OnInputChanged"
                                     For="() => _model.DimensionA"/>
                    <MudNumericField Label="Rozměr B v milimetrech"
                                     Margin="Margin.Normal"
                                     @bind-Value="_model.DimensionB"
                                     @bind-Value:after="OnInputChanged"
                                     For="() => _model.DimensionB"/>
                    <MudNumericField Label="Rozměr C v milimetrech"
                                     Margin="Margin.Normal"
                                     @bind-Value="_model.DimensionC"
                                     @bind-Value:after="OnInputChanged"
                                     For="() => _model.DimensionC"/>

                    <MudSelect @bind-Value="_model.RoofType"
                               @bind-Value:after="OnInputChanged"
                               Label="Typ střechy"
                               Margin="Margin.Normal">
                        @foreach (var dropDownItem in _roofTypeItems)
                        {
                            <MudSelectItem Value="@dropDownItem">@dropDownItem.DisplayText</MudSelectItem>
                        }
                    </MudSelect>

                    <div class="mt-6 mb-6">
                        <MudText Typo="Typo.h5" GutterBottom="true">Odhad výsledné ceny:</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_priceEstimate.ToString("C0", _cultureInfo)</MudText>
                    </div>

                    <MudText Typo="Typo.h5" Class="mb-4">Zanechte nám na sebe kontakt</MudText>

                    <MudTextField Label="Telefon" Margin="Margin.Normal"
                                  @bind-Value="_model.PhoneNumber" For="@(() => _model.PhoneNumber)"/>
                    <MudTextField Label="E-mail" Margin="Margin.Normal"
                                  @bind-Value="_model.Email" For="@(() => _model.Email)"/>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-end pa-4">
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               FullWidth="true"
                               Disabled="@_isSubmitting"
                               Style="max-width: 400px; height: 48px; border-radius: 0;">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                            <MudText>Odesílání...</MudText>
                        }
                        else
                        {
                            <MudText>Zaslat kontakt, ozveme se</MudText>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {

    bool success;
    decimal _priceEstimate = 0.0m;
    CultureInfo _cultureInfo = new CultureInfo("cs-CZ");

    private void OnInputChanged()
    {
        _priceEstimate = _model.DimensionA * _model.DimensionB * _model.DimensionC * _model.RoofType.Id / 1000;
    }

    private bool _isSubmitting = false;

    private async Task OnValidSubmit(EditContext context)
    {
        if (_isSubmitting)
            return;

        _isSubmitting = true;
        StateHasChanged();

        try
        {
            // Send email with all form data
            var emailSent = true;
            @* var emailSent = await EmailService.SendConfiguratorInquiryAsync(
                _model.DimensionA,
                _model.DimensionB,
                _model.DimensionC,
                _model.RoofType.DisplayText,
                _model.PhoneNumber,
                _model.Email,
                _priceEstimate); *@

            if (emailSent)
            {
                success = true;
                Snackbar.Add("Děkujeme! Vaše poptávka byla úspěšně odeslána. Náš obchodní zástupce se Vám brzy ozve.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Omlouváme se, ale při odesílání poptávky došlo k chybě. Zkuste to prosím později nebo nás kontaktujte přímo.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Nepodařilo se odeslat poptávku. Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        OnInputChanged();
    }

    private static readonly List<DropDownItem> _roofTypeItems = new List<DropDownItem>
    {
        new((int)RoofType.Flat, "Rovná"),
        new((int)RoofType.Pitched, "Sedlová")
    };

    private readonly ConfiguratorFormInputData _model = ConfiguratorFormInputData.Default;

    public enum RoofType
    {
        Unknown,
        Flat,
        Pitched
    }

    public class ConfiguratorFormInputData
    {
        public static ConfiguratorFormInputData Default =>
            new()
                {
                    DimensionA = 1000,
                    DimensionB = 1000,
                    DimensionC = 1000,
                    RoofType = _roofTypeItems.First(),
                    PhoneNumber = "+420123456789",
                    Email = "muj.email@seznam.cz"
                };

        [Required]
        public decimal DimensionA { get; set; }

        [Required]
        public decimal DimensionB { get; set; }

        [Required]
        public decimal DimensionC { get; set; }

        [Required] public DropDownItem RoofType { get; set; }

        [Required(ErrorMessage = "Prosím vyplňte telefonní číslo")] public string PhoneNumber { get; set; }

        [Required(ErrorMessage = "Prosím vyplňte email")] public string Email { get; set; }
    }
}