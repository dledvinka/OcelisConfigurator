@page "/configurator-form"
@inject ISnackbar Snackbar
@inject IEmailService EmailService
@inject VaznikMaterialyReader VaznikMaterialyReader
@inject CenikReader CenikReader
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@inject ILoggerFactory LoggerFactory
@inject ILogger<ConfiguratorFormPage> Logger
@inject Microsoft.ApplicationInsights.TelemetryClient TelemetryClient
@using System.ComponentModel.DataAnnotations
@using System.Globalization
@using Ocelis.Configuration.BlazorApp.Components.Shared
@using Ocelis.Configuration.BlazorApp.Domain
@using Ocelis.Configuration.BlazorApp.Services
@using Ocelis.Configuration.Domain.Entities
@using Ocelis.Configuration.Domain.Enums
@using Ocelis.Configuration.Domain.Extensions
@using Ocelis.Configurator.Application.Cenik
@using Ocelis.Configurator.Application.Logic
@using Ocelis.Configurator.Application.Materialy

<EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid>

        <MudItem xs="12" md="6" Class="d-flex justify-center align-center" >
            @if (_model.StavbaTyp.Id == (int)VaznikTyp.Plochy)
            {
                <MudImage ObjectFit="ObjectFit.Cover" Src="images/RovnaStrecha_600_600.jpg" Alt="Rovný typ střechy" Class="rounded-lg" Style="width: 100%; height: 682px; max-width: 682px; max-height: 682px;" />
            }
            else
            {
                <MudImage ObjectFit="ObjectFit.Cover" Src="images/SedlovaStrecha_600_600.jpg" Alt="Šikmý typ střechy" Class="rounded-lg" Style="width: 100%; height: 682px; max-width: 682px; max-height: 682px;" />
            }
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h5" Class="mb-4">Zadejte požadované rozměry, typ stavby a sklon střechy</MudText>

                    <MudSelect @bind-Value="_model.StavbaTyp"
                    @bind-Value:after="OnStavbaTypChanged"
                    Label="Typ stavby"
                    Margin="Margin.Normal">
                        @foreach (var dropDownItem in _stavbaTypItems)
                        {
                            <MudSelectItem Value="@dropDownItem">@dropDownItem.DisplayText</MudSelectItem>
                        }
                    </MudSelect>

                    <MudSelect @bind-Value="_model.VaznikTyp"
                    @bind-Value:after="OnInputChanged"
                    Label="Sklon střechy"
                    Margin="Margin.Normal">
                        @foreach (var dropDownItem in AvailableVaznikTypItems)
                        {
                            <MudSelectItem Value="@dropDownItem">@dropDownItem.DisplayText</MudSelectItem>
                        }
                    </MudSelect>

                    <MudNumericField Label="Počet otvorů větším než 2m²"
                    Margin="Margin.Normal"
                    Min="0"
                    @bind-Value="_model.PocetVelkychOtvoru"
                    @bind-Value:after="OnInputChanged"
                    For="() => _model.PocetVelkychOtvoru"/>

                    <MudNumericField Label="Délka stavby v metrech"
                    Margin="Margin.Normal"
                    Min="1.0m"
                    Step="0.1m"
                    @bind-Value="_model.DelkaStavbyVMetrech"
                    @bind-Value:after="OnInputChanged"
                    For="() => _model.DelkaStavbyVMetrech"/>
                    <MudNumericField Label="Šířka stavby v metrech"
                    Margin="Margin.Normal"
                    Min="1.0m"
                    Step="0.1m"
                    @bind-Value="_model.SirkaStavbyVMetrech"
                    @bind-Value:after="OnInputChanged"
                    For="() => _model.SirkaStavbyVMetrech"/>
                    <MudNumericField Label="Světlá výška stěn v metrech"
                    Min="1.0m"
                    Step="0.1m"
                    Margin="Margin.Normal"
                    @bind-Value="_model.SvetlaVyskaStenVMetrech"
                    @bind-Value:after="OnInputChanged"
                    For="() => _model.SvetlaVyskaStenVMetrech"/>

                    <div class="mt-6 mb-6">
                        <MudText Typo="Typo.h5" GutterBottom="true">Odhad výsledné ceny:</MudText>
                        @if (_priceEstimate.HasValue)
                        {
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_priceEstimate?.ToString("C0", _cultureInfo)</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.h5" Color="Color.Primary">@_priceMessage</MudText>
                        }
                    </div>

                    <MudText Typo="Typo.h5" Class="mb-4">Zanechte nám na sebe kontakt</MudText>

                    <MudTextField Label="Telefon" Margin="Margin.Normal"
                    @bind-Value="_model.PhoneNumber" For="@(() => _model.PhoneNumber)"/>
                    <MudTextField Label="E-mail" Margin="Margin.Normal"
                    @bind-Value="_model.Email" For="@(() => _model.Email)"/>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-end pa-4">
                    <MudButton ButtonType="ButtonType.Submit"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    FullWidth="true"
                    Disabled="@_isSubmitting"
                    Style="max-width: 400px; height: 48px; border-radius: 0;">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                            <MudText>Odesílání...</MudText>
                        }
                        else
                        {
                            <MudText>Zaslat kontakt, ozveme se</MudText>
                        }
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {

    bool success;
    decimal? _priceEstimate;
    CultureInfo _cultureInfo = new CultureInfo("cs-CZ");

    private List<DropDownItem> AvailableVaznikTypItems
    {
        get
        {
            // If Vestavek is selected, only allow Plochy
            if (_model.StavbaTyp.Id == (int)StavbaTyp.Vestavek)
            {
                return _vaznikTypItems
                    .Where(x => x.Id == (int)VaznikTyp.Plochy)
                    .ToList();
            }

            // Otherwise, allow all VaznikTyp options
            return _vaznikTypItems;
        }
    }

    private void OnStavbaTypChanged()
    {
        // If Vestavek is selected and current VaznikTyp is not Plochy, reset to Plochy
        if (_model.StavbaTyp.Id == (int)StavbaTyp.Vestavek &&
            _model.VaznikTyp.Id != (int)VaznikTyp.Plochy)
        {
            _model.VaznikTyp = _vaznikTypItems.First(x => x.Id == (int)VaznikTyp.Plochy);
        }

        OnInputChanged();
    }

    private void OnInputChanged()
    {
        var vypocetCeny = new VypocetCeny(LoggerFactory.CreateLogger<VypocetCeny>(), _vaznikMaterialy, _cenik);

        var zakazka = new Zakazka()
        {
            StavbaTyp = (StavbaTyp)_model.StavbaTyp.Id,
            VaznikTyp = (VaznikTyp)_model.VaznikTyp.Id,
            Delka = Vzdalenost.FromMetry((double)_model.DelkaStavbyVMetrech),
            Sirka = Vzdalenost.FromMetry((double)_model.SirkaStavbyVMetrech),
            SvetlaVyskaSten = Vzdalenost.FromMetry((double)_model.SvetlaVyskaStenVMetrech),
            Cenik = _cenik,
            CProfilTyp = CProfilTyp.C89x41x1_0,
            PocetVelkychOtvoru = _model.PocetVelkychOtvoru,

        };

        var delkaVazniku = Math.Min(zakazka.Delka.Metry, zakazka.Sirka.Metry);
        var sirkaVazniku = Math.Max(zakazka.Delka.Metry, zakazka.Sirka.Metry);

        zakazka.Mistnosti = new List<Mistnost>()
        {
            new Mistnost("A", Vzdalenost.FromMetry(delkaVazniku), Vzdalenost.FromMetry(sirkaVazniku))
        };

        _zakazka = zakazka;
        _zakazkaCena = vypocetCeny.VypoctiCenuZakazky(zakazka);

        if (_zakazkaCena.LzeVypocitat)
        {
            _priceEstimate = _zakazkaCena.CenaCelkemCzk.Value;
        }
        else
        {
            _priceEstimate = null;
            _priceMessage = _zakazkaCena.Popis;
        }
        
    }

    private bool _isSubmitting = false;

    private async Task OnValidSubmit(EditContext context)
    {
        if (_isSubmitting)
            return;

        _isSubmitting = true;
        StateHasChanged();

        Logger.LogInformation("Form submission started. Email: {Email}, Phone: {Phone}, Price: {Price} CZK",
            _model.Email, _model.PhoneNumber, _priceEstimate);

        try
        {
            // Send email with all form data
            var emailSent = await EmailService.SendEmailAsync(_model.Email, new EmailMessageModel()
            {
                CustomerEmail = _model.Email,
                CustomerPhone = _model.PhoneNumber,
                Zakazka = _zakazka,
                ZakazkaCena = _zakazkaCena
            });

            if (emailSent)
            {
                success = true;

                // Track custom metrics for business reporting
                TelemetryClient.TrackEvent("InquirySubmitted", new Dictionary<string, string>
                {
                    { "CustomerEmail", _model.Email },
                    { "CustomerPhone", _model.PhoneNumber },
                    { "StavbaTyp", _model.StavbaTyp.DisplayText },
                    { "VaznikTyp", _model.VaznikTyp.DisplayText },
                    { "Delka", _model.DelkaStavbyVMetrech.ToString() },
                    { "Sirka", _model.SirkaStavbyVMetrech.ToString() },
                    { "Vyska", _model.SvetlaVyskaStenVMetrech.ToString() }
                });

                if (_priceEstimate.HasValue)
                {
                    TelemetryClient.TrackMetric("OrderValue", (double)_priceEstimate.Value);
                }

                Logger.LogInformation("Inquiry submitted successfully. Email: {Email}, Price: {Price} CZK",
                    _model.Email, _priceEstimate);

                Snackbar.Add("Děkujeme! Vaše poptávka byla úspěšně odeslána. Náš obchodní zástupce se Vám brzy ozve.", Severity.Success);
            }
            else
            {
                Logger.LogWarning("Email send failed for customer {Email}", _model.Email);
                Snackbar.Add("Omlouváme se, ale při odesílání poptávky došlo k chybě. Zkuste to prosím později nebo nás kontaktujte přímo.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Form submission failed. Email: {Email}, Phone: {Phone}, Price: {Price} CZK",
                _model.Email, _model.PhoneNumber, _priceEstimate);
            Snackbar.Add($"Nepodařilo se odeslat poptávku. Chyba: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Loading configurator data...");

        var uri = NavigationManager.ToAbsoluteUri("data/Materialy.csv");
        var csvFileStream = await HttpClient.GetStreamAsync(uri);
        _vaznikMaterialy = await VaznikMaterialyReader.ReadAsync(csvFileStream);
        _cenik = CenikReader.GetCenik();

        OnInputChanged();

        Logger.LogInformation("Configurator initialized successfully. Materials: {MaterialCount}", _vaznikMaterialy.Count);
    }

    private static readonly List<DropDownItem> _stavbaTypItems =
        EnumExtensions.GetStavbaTypItems()
            .Select(x => new DropDownItem((int)x.Value, x.Description))
            .ToList();

    private static readonly List<DropDownItem> _vaznikTypItems =
        EnumExtensions.GetVaznikTypItems()
            .Select(x => new DropDownItem((int)x.Value, x.Description))
            .ToList();

    private readonly ConfiguratorFormInputData _model = ConfiguratorFormInputData.Default;
    private List<VaznikMaterial> _vaznikMaterialy;
    private Cenik _cenik;
    private ZakazkaCena _zakazkaCena;
    private Zakazka _zakazka;
    private string _priceMessage;

    public class ConfiguratorFormInputData
    {
        public static ConfiguratorFormInputData Default =>
            new()
                {
                    DelkaStavbyVMetrech = 5,
                    SirkaStavbyVMetrech = 8,
                    SvetlaVyskaStenVMetrech = 3,
                    StavbaTyp = _stavbaTypItems.First(),
                    VaznikTyp = _vaznikTypItems.First(),
                    PocetVelkychOtvoru = 4,
                    PhoneNumber = "+420123456789",
                    Email = "muj.email@seznam.cz"
                };

        public DropDownItem VaznikTyp { get; set; }

        [Required]
        public decimal DelkaStavbyVMetrech { get; set; }

        [Required]
        public decimal SirkaStavbyVMetrech { get; set; }

        [Required]
        public decimal SvetlaVyskaStenVMetrech { get; set; }

        [Required] public DropDownItem StavbaTyp { get; set; }

        [Required(ErrorMessage = "Prosím vyplňte telefonní číslo")] public string PhoneNumber { get; set; }

        [Required(ErrorMessage = "Prosím vyplňte email")] public string Email { get; set; }
        
        public int PocetVelkychOtvoru { get; set; }
    }
}